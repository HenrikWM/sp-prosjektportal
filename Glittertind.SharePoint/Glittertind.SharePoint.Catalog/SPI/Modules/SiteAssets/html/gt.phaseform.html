<script type="text/javascript" src="../../../SiteAssets/gt/js/gt.generics.js"></script>
<script type="text/javascript" src="../../../SiteAssets/gt/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" language="javascript">
    this.previousPhase = "";
    jQuery(document).ready(function () {
        this.previousPhase = jQuery('#onetIDListForm div[id^="GtProjectPhase"] .ms-taxonomy-control-holder .ms-taxonomy-fieldeditor span.valid-text').text();
        var editMode = getParameterByName('EditMode');
        if (editMode != '' && editMode != undefined) {
            if (editMode == "Project") {
                // Jesus chist :D Hiding the "Open this web part page"-text
                jQuery('#onetIDListForm .ms-webpart-chrome.ms-webpart-chrome-vertical.ms-webpart-chrome-fullWidth > div > table > tbody > tr > td> table:nth-child(2)').hide();
                //Hide content type picker and name and title field (as it's applicable for the page, not the web
                jQuery('#onetIDListForm input[id^="FileLeafRef"]').closest('tr').hide();
                jQuery('#onetIDListForm select[title="Innholdstype"]').closest('tr').hide();
                jQuery('#onetIDListForm input[title="Tittel"]').closest('tr').hide();
            }
            else if (editMode == "PhaseOnly") {
                // Jesus chist :D Hiding the "Open this web part page"-text
                jQuery('#onetIDListForm .ms-webpart-chrome.ms-webpart-chrome-vertical.ms-webpart-chrome-fullWidth > div > table > tbody > tr > td> table:nth-child(2)').hide();
                // Hide all rows but the phase picker
                jQuery('#onetIDListForm table.ms-formtable > tbody > tr').hide();
                jQuery('#onetIDListForm div[id^="GtProjectPhase"]').closest('tr').show();
            }
        }
    });
    function PreSaveAction() {
        var newPhase = jQuery('#onetIDListForm div[id^="GtProjectPhase"] .ms-taxonomy-control-holder .ms-taxonomy-fieldeditor span.valid-text').text();
        var oldPhase = this.previousPhase;

        if (newPhase != oldPhase) {
            $.when(GT.Project.ChangePhase(newPhase)).then(
                function() {
                    return true;
                });
        } else {
            return true; // if you want to execute save functionality of the form.
        }
    }
</script>